# ДЗЕН

## 1. Тема и целевая аудитория

Выбран сервис dzen

Дзен — российская блог-платформа для создания и просмотра контента

Аудитория:
- MAU 79M [7] и [8]
- DAU 31M [9]

По странам [8]:
1. Россия - 95,43% - 75,3М
2. Беларусь - 1,14% - 0,9М
3. Казахстан - 0,55% - 0,4М
4. Украина - 0,44% - 0,35М

Ключевой функционал - просмотр и реакция на посты

Ключевое продуктовое решение - весь контент создаётся пользователями

Выделен следующий функционал MVP:
- Поиск (по постам, авторам)
- Чтение постов
- Написание постов с вложением картинок
- Комментарии
- Авторизация
+ Подписки
+ Рекомендации
+ Монетизация

## 2. Расчет нагрузки

Анализ трафика:

- 100 млн пользователей [1]
- 2,7 млн постов ежемесячно [2]
- 100к пользователей пишут ежемесячно [3]
- 500к коментариев ежедневно, но тогда DAU был 20М, а сейчас 31М => 750к [4]
- 5 млрд часов проведено на сайте за год (2024) [6]
- добавляется 1 млн авторов ежегодно [6]
- время пользователей : 40% видео, 60% текстов [5]

Средний размер хранилища пользователя 5,55 мб:
- 1,5 Мб фотография

    вычислил путём среднего от 10 фотографий (не иконок которые меньше весят). Получили: (406 + 6100 + 143 + 120 + 4400 + 108 + 222 + 380 + 1400 + 543)кб / 10 = 13824 кб / 10 ~= 1,5 Мб

- 50кб коментариев

  по [17] с 2019 года начался основной рост (с 8,7М DAU -> 13M DAU) будем считать что средний возраст профиля 5-6 лет т.е. 5,5 лет т.е 2000 дней. По таблице ниже каждый день пользователь делает 0,025 коментариев => 2000 * 0,025 = 50 коментариев. Средний вес коментария 1кб => 50кб

- 2 поста

  аналогично с коментариями 2000 * 0,001 = 2. Пост в среднем весит 2048кб ~= 2 мб => 2 * 2 = 4мб постов


- 3 Кб Информация о пользователе
  - 140 символов * 2 байта = 280 байт на имя
  - 300 * 2 = 600 байт на описание
  - 1 Кб на ссылки (свой сайт, на соцсети)

Действия пользователя:

|Действие|Количество а пользователя|Обоснование|
|--|--|--|
|Главная|1|При на жатии на интересный пост открывается новая вкладка и заходить на главную не надо можно просто закрыть вкладку со статьёй|
|Чтение статьи|15|В среднем пользователь проводить 18 минут за чтением статей: 5 млрд часов[6] * 0.63 процент чтения статей[6] / 365 дней / 30млн пользователей ежедневно * 60 минут в часу<br> По статистике канала "Упал поднялся" Статью читают 1,2 минуты[13] crt 0,09. Значит за день пользователь читает 15 статей|
|Написание статьи|0,001|Ежемесячно 100 000 авторов[6] пишут 2,7 млн постов[2]. Примерно 27 пост на автора или 0,9 поста в день. При MAU 79M в среднем пользователь пишет 0,034 постов в месяц или 0,001 пост в день|
|Коментарии|0,025|в день оставляют 750к[4] коментариев значит при DAU 31M пользователь пишет 0,025 коментариев в день|
|Коментарии(чтение)|6,6|При дочитывании статьи появляются коментарии. На основе статистики канала "Упал поднялся" статью дочитывают 44% человек. Отсюда 15 * 0,44 = 6,6|
|Регистрация|0,00009|1 млн авторов регестрируются ежегодно[6]. Значит в день регестрируются 2,8к пользователей. При DAU 31М получаем 0,00009|
|Подписка|0,002|По статистики zenstats на 50 самый больших каналов[12] по подписчикам подписалось за месяц 500к. Прогназирую 5М подписок ежемесячно. Значит при MAU 79M каждый пользовать сделал 0,07 подписок в месяц или 0,002 подписки в день|
|Рекомендации|17,5|(10000 rps[1] * 86400 сек / 31M DAU) * 0,63 процент чтения статей = 17,5 запросов к рекомендациям|
|Монетизация|-|-|
|Поиск|0,27|1,8 % людей переходят на посты[14] . В других источниках нет нормальных процентов (<1%)<br> 15 * 0,018 = 0,27|
|Авторизация|0,01|Открыты данных по авторизации нет, но из-за того что сессии сйчас живут долго можем предположить следующий рассчёт: из-за того что сайт новостной, то авторизованных пользователей 60%. Пусть 20% пользователей будут авторизовываться в месяц =>79 000 000 MAU * 0,6 * 0,2 = 9 500 000 в месяц => 9 500 000 / 30 дней = 316 000 в день => 316 000 / 31 000 000 DAU = 0,01 на пользователя|


- 1 раз в день пользователь заходит на главную. При нажатии на интересный пост открывается новая вкладка => 2 раз заходить на главную не надо.
- В среднем пользователь проводит 18 минут за чтением статей (5 млрд часов * 0.63 процент чтения статей / 365 дней / 30млн пользователей ежедневно * 60 минут в часу)
- По статистике канала "Упал поднялся" Статью читают 1,2 минуту. Значит за день пользователь читает 18 статей
- Ежемесячно 100 000 авторов пишут 2,7 млн постов. Примерно 27 пост на автора или 0,9 поста в день. При MAU 79M в среднем пользователь пишет 0,034 постов в месяц или 0,001 пост в день
- в день оставляют 750к коментариев значит при DAU 31M пользователь пишет 0,025 коментариев в день
- 1 млн авторов регестрируются ежегодно. Значит в день регестрируются 2,8к пользователей. При DAU 31М получаем 0,00009
- По статистики zenstats на 50 самый больших каналов по подписчикам подписалось за месяц 500к. Прогназирую 5М подписок ежемесячно. Значит при MAU 79M каждый пользовать сделал 0,07 подписок в месяц или 0,002 подписки в день
- По рекомендациям есть 10k rps
- По монетизации ничего пока нету :(

Разбивка по данным:

|Табличка|Размер|Обоснование|
|--|--|--|
|Пользователи|300 Гб (48 Тб с аватаром)|Всего пользователей 100млн[1] => 3 Кб данных о пользователе * 100 000 000 = 300 Гб.<br> Если считать с картинками, то 1,503 Мб * 100 000 000 = 144 Тб, но эти данные завышены так как не у всех пользователей есть аватарки. Сервис предоставляет 3 вида аватарок (белый человечек, абстракция, животные ии (штук 20)).<br> Я взял для анализа коментарии следующей статьи https://dzen.ru/a/aMh3qNPKJCJqDMDH - 396 коментаиев из которых ~= 105 с автарками. Сделаем погрешность и будет считать что каждый третий пользователь имеет аватарку (33,4 * 1,503 мб + 66,6 * 0,003 мб) * 1 000 000 = 48 Тб данных|
|Посты|976 Гб (245 тб с фото)|в 2023 году 20 млн постов и 14 млн статей. Это на 40% больше чем в прошлом году[15] => В прошлом году было 34 * 0,6 = 20 млн постов <br> в 2022 году[16] количество контента вырасло в 3 раза => В прошлом году было 20 / 3 ~= 8 млн постов <br> С 2015 - 2021 (6 лет) = 8 * 6 = 24. Т.к. за 6 лет произошёл рост аудитории сократим количество постов до 20 млн. <br> Итого: 40 (в 2024 прогназируем) + 34 + 20 + 8 + 20 = 122 млн постов <br>Взял 50 постов на zenstat[2] и вычислил среднее время = 4 минуты это примерно 4000 символов [11] ~= 8кб (uft8) <br> 8кб * 122млн = 976 Гб. В среднем на 1 пост 6 картинок. Средний вес картинки 340 кб => 6 * 340кб = 2 мб => 122млн * 2мб = 244 тб фото или 245 тб если считать и текст|
|Коментарии|2тб|В 2020 году пользователи писали 500к коментариев[4] => 10 лет * 365 дней * 500к ~= 2 млрд коментариев. Взял такое число потому что 2020 ровно середина между 2015 (создание) и 2025 годом. Тогда DAU был 20М, а сейчас 31М. В среднем один коментарий весит 1 кб (рассчитано средним по статье) => 2 млрд * 1 кб = 2 тб|

Рост данных в год:

|Табличка|В год|Обоснование|
|--|--|--|
|Пользователи|3 гб (500 гб с фото)|1 млн авторов регестрируются ежегодно[6]. 3кб вес 1 пользователя => 1 млн * 3 кб = 3гб. Если учитывать фото, то 1,503 Мб * 0.33 шанс * 1 млн = 500гб|
|Посты|320 Гб (80 тб с фото)| 40 млн (прогнаируем так как 34 млн в 2023 и был заметный рост 40%). 8 кб средний вес поста => 40 млн * 8кб = 320гб <br> Если учитывать картинки, то 2мб * 40 млн = 80 тб|
|Коменарии|273 Гб |500к коментариев ежедневно, но тогда DAU был 20М, а сейчас 31М => 750к [4]. 1 кб * 750 000 * 365 = 273 гб|
|Подписки|30 Гб|5 млн подписок в месяц или 60 млн в год. Каждая подписка 0,5 кб => 60 млн * 0,5 кб = 30 Гб|

- Всего пользователей 100М => 1,503 Мб * 100 000 000 = 144 Тб
  - 1,5 Мб * 100 000 000 = 143 Тб - эти данные завышены так как не у всех пользователей есть аватарки. Серевис предоставляет 3 вида аватарок (белый человечек, абстракция, животные ии (штук 20))
  - 0,003 Мб * 100 000 000 = 300 Гб

  - Я взял для анализа коментарии следующей статьи https://dzen.ru/a/aMh3qNPKJCJqDMDH - 396 коментаиев из которых ~= 105 с автарками. Сделаем погрешность и будет считать что каждый третий пользователь имеет аватарку (33,4 * 1,503 + 66,6 * 0,003) * 1 000 000 = 48 Тб данных
- Посты:
  - в 2023 году 20 млн постов и 14 млн статей. Это на 40% больше чем в прошлом году => В прошлом году было 34 * 0,6 = 20 млн постов
  - в 2022 году количество контента вырасло в 3 раза => В прошлом году было 20 / 3 ~= 8 млн постов
  - С 2015 - 2021 (6 лет) = 8 * 6 = 24. Т.к. за 6 лет произошёл рост аудитории сократим количество постов до 20 млн.
  - Итого: 40 (в 2024 прогназируем) + 34 + 20 + 8 + 20 = 122 млн постов
  - Взял 50 постов на zenstat и вычислил среднее время = 4 минуты это примерно 4000 символов [11] ~= 8кб (uft8)
  - 8кб * 122млн = 976 Гб
  - В среднем 6 картинок в посте (минимум 1, максимум 22 но очень длинная статья, в обычных по 4 фото)
  - Средний вес картинки (смотрел черерз network): 340кб
  - Вместе с картинками (340 кб * 6 + 8 кб) * 122 млн = 244 тб
  - В 2020 году пользователи писали 500к коментариев => 10 лет * 365 дней * 500к ~= 2 млрд коментариев
  - В среднем коментарий весит = (22 561 символа * 2 байта) / 48 = 940байт ~= 1 кб
  - Значит всего 2 млрд * 1 кб = 2 тб 

Rps и сетевая нагрузка:
|Действие|RPS|RPS пик|Сеть|Сеть пик|Сеть в день|
|--|--|--|--|--|--|
|Лента постов|360|620|3,7 Гб/c|6,4 гб/c| 322,4 тб|
|Чтение постов|5 400|9 300|12,4 гб/с|21,3 гб/c|1 Пб|
|Написание постов|1|2|2,3 мб/с|4,6 мб/c| 207 гб|
|Коментарии|9|16|9 кб/с|16 кб/с|750 мб|
|Коментарии(чтение)|2 400|4 150|19,2 мб/с|33 мб/c|1,63 тб|
|Рекомендации|6 300|10 900|31 мб/с|53,3 мб/c|3,8 Тб|
|Регистрация|0,001|0,002|0,005 кб/c|0,01кб/c|14 мб|
|Подписка|0,7|1,2|1,4 кб/c|2,4 кб/c|61 мб|
|Монетизация|-|-|-|-|
|Поиск|96|165|0,5 мб/с|0,86 мб/с|42гб|
|Авторизация|3,6|6|4 кб/c|6 кб/c|

Рассмотрим трафик однокласников (похожая аудитория и её расположение)

<img width="786" height="427" alt="image" src="https://github.com/user-attachments/assets/89fa9ad1-2599-4043-b042-c00daf610dd3" />

1375 * 5 + (2 * (1375 - 675) / 2) + (4 * (675 - 175) / 2) + (3 * (300 - 175) / 2) + (3 * (1250 - 300) / 2) + (7 * 1250) = 19 000

19 000 / 24 = 800

1375 / 800 = 1,72



- Лента постов
  - (307 + 211 + 403 + 882 + 520 + 5 + 93) / 7 = 2421 кб / 7 = 345 кб на шапку поста
  - 0,4 кб (200 символов) на короткое вступление
  - 1кб на пост (ссылки на аватарку и шапку поста, имя пользователя, время чтения и вступление)
  - Размер аватарки автора поста ~= 2кб
  - Личный опыт - листается порядка 30 постов на главной => (345 + 2 + 1) * 30 = 10,4 мб картиной
  - 31 000 000 / 86 400 = 360 rps в среднем => 360 * 10,4 = 3,7 Гб/c
  - 360 * 1,72 = 620 rps в пике => 626 rps * 30 постов * 1кб = 24 мб/с в пике текста или 626 * 10,4 мб = 6,4 гб/c в пике с картинками
  - 31 000 000 * 30 постов * 1 кб = 930 гб трафика в день или 31 000 000 * 10,4 мб = 322,4 Тб с картинками
- Пост
  - 8 кб текст поста
  - В посте в среднем 5,6 картинок по 411 кб = 2,2мб картинок на пост + 8 кб поста= 2,3мб
  - (15 статей в день * 31 000 000 DAU) / 86 400 = 5 400 rps в среднем => 5 400 * 2,3 = 12,4 гб/c в среднем
  - 5 400 * 1,72  = 9 300 rps в пике => 9 300 * 16кб = 148 мб/c текста или 9 300 * 2,3 мб = 21,3 гб/с с картинками
  - 31 000 000 DAU * 15 статей в день * 8 кб текста = 3,7 Тб трафика в день или 31 000 000 DAU * 15 статей в день * 2,3мб = 1 пб в день
- Написание постов
  - В день 2 700 000 постов в месяц / 30 дней = 90 000 => 90 000 постов в день / 86 400 секунд = 1 rps в среднем => 1 * 2,3 = 2,3 мб/c в среднем
  - В посте в среднем 5,6 картинок по 411 кб = 2,3мб картинок на пост (ещё пост 8 кб)
  - В пике 1 rps * 1,72 = 2 rps в пике => 2 * 8 kb = 16 кб/с или 2 * 2,3мб = 4,6 мб/c
  - 2 700 000 * 8кб / 30 = 720 Мб трафика в день или 2 700 000 * 2,3 мб / 30 = 207 гб трафика в день
- Коментарии
  - Средний размер коментария ~= 1кб
  - 750 000 / 86 400 = 9 rps => 9 кб/c в среднем
  - Пиковый = 9 * 1,72 = 16 rps => 16 rps * 1 кб = 16 кб /c в пике
  - 750 000 * 1 кб = 750 Мб трафика в день
- Коментарии (чтение)
  - Средний размер коментария ~= 1кб
  - 750к коментариев в день * 30 дней = 22 500 000 коментариев в месяц. 22,5М коментариев / 2,7 млн постов = 8 коментариев на пост = 8 кб
  - 6,6 * 31 000 000 DAU * 8 кб = 1,63 Тб трафика в день
  - (6,6 чтений в день * 31 000 000 DAU) / 86 400 = 2 400 RPS => 2 400 * 8кб = 19,2 мб/c
  - 2 400 * 1,72 = 4 150 RPS в пике => 4 150 RPS * 8кб = 41,6 мб/c
- Подписка
  - Пусть вес запроса будет 1кб
  - (0,002 подписок в день * 31 000 000 DAU) / 86 400 = 0,7 RPS => 0,7 RPS * 1кб = 1 кб/c в среднем
  - 0,7 RPS * 1,72 = 1,2 RPS => 1,2 * 1 = 1,2 кб/c в пике
  - 0,7 RPS * 86 400 с * 1кб = 61 мб трафика в день
- Регистрация
  - Пусть вес запроса будет 5кб
  - 0,00009 в день * 31 000 000 DAU / 86 400 = 0,001 RPS (на калькуляторе ещё меньше я не хочу вводить 0) => 0,001 * 5 = 0,005кб/c
  - 0,001 RPS * 1,72 = 0,002 RPS => 0,002 * 5 = 0,01 кб/c
  - 0,00009 * 31 000 000 * 5 = 14мб трафика в день
- Рекомендации (10тыс rps)
  - 10тыс rps на весь контент. При этом только 63% тексты => 6300 rps рекомендаций => 6300 * 5 = 31 мб/c
  - При просмотре статьи в конце предоставляют 4 поста на выбор, после идёт следующий пост ~= 4кб
  - За раз на стену приходит 7 рекомендованных постов ~= 7кб
  - В среднем получаем 5 постов за 1 рекомендацию с картинками ~= 5кб
  - В пике 6 300 * 1,72 = 10 900 rps => 10 900 * 5 кб = 53,3 мб/с в пике
  - 6 300 rps * 86 400 секунд в дне * 5 кб ответ = 3,8 Тб трафика в день
- Поиск
  - Пусть вес запроса будет 5кб
  - 0,27 * 31 000 000 DAU / 86 400 сек = 96 RPS * 5кб = 0,5 мб/c в среднем
  - В пике 96 * 1,72 = 165 RPS * 5кб = 0,86 мб/c в пике
  - 0,27 * 31 000 000 DAU * 5 кб = 42 Гб трафика в день
- Авторизация
  - Пусть вес запроса будет 1кб
  - 0,01 * 31 000 000 DAU / 86 400 сек = 3,6 rps => 3,6 * 1 кб = 4 кб/с в среднем
  - В пике 3,6 * 1,72 = 6 rps => 6 rps * 1кб = 6 кб/c в пике
  - 0,01 * 31 000 000 * 1 кб = 310 мб трафика в день    

## 3. Глобальная баласировка

На основе следующих данных[20]:
- 34% — Москва и Питер
- 25% — города более >1М
- 11% — города 500 тыс - 1 млн
- 30% — остальное

Разместим сервис в ДЦ для быстрого доступа 70% пользователям.

Выбраны 4 дц что бы захватывать большую часть городов от 100тыс [18]:
1. 3 ДЦ в Москв - раздляют между собой Европейскую часть россии
2. 1 ДЦ в Новосибирске - забирает трафик с остальной России

Распределение нагрузки по ДЦ:

|Сервер|Нагрузка|Обоснование|
|--|--|--|
|Москва|78% <br>(26% на каждый ДЦ)|34% + 16,6% (2/3 городов милионников) + 7,3% (2/3 полумилионников) + 20% (остаток)|
|Новосибирск|22%|8,3% (миллионники) + 3,6% (полумиллионники) + 10%(остаток)|

DNS балансировка Latency Based (как оказалось Geo-DNS  работает по 1 континенту. С Москвы до Казани меньше чем с Казани до Новосибирска. Под вопросом Екатеринбург), что бы разделить трафик на 2 региона. Если сервер в Новосибирске выйдет из строя будет выдан DNS Москвы.

anycast будем использовать для Москвы чтобы при выходе из строя сервера в Москве сразу было переключение на следующий (даже с учётом кеша у DNS).

<img width="1096" height="611" alt="image" src="https://github.com/user-attachments/assets/543a226a-887e-4106-b896-ef68c9740cb2" />

Города так же выбраны на основе магистралей - наибольшие выходы именно из этих городов [19]
<img width="1367" height="726" alt="image" src="https://github.com/user-attachments/assets/399ae625-ecc5-46c9-9c5e-64256c06711f" />


| Действие             | Сеть пик         | **Москва ДЦ 1 (26%)**  | **Москва ДЦ 2 (26%)**  |  **Москва ДЦ 3 (26%)** |  **Новосибирск (22%)** |
|----------------------|------------------|------------------------|------------------------|------------------------|------------------------|
| **Лента постов**     | 6.4 Гб/c         | 1.66 Гб/c              | 1.66  Гб/c             | 1.66 Гб/c              | 1.41 Гб/c              |
| **Чтение постов**    | 21.3 Гб/c        | 5.54 Гб/c              | 5.54 Гб/c              | 5.54 Гб/c              | 4.69 Гб/c              |
| **Написание постов** | 4.6 Мб/с         | 1.20 Мб/с              | 1.20 Мб/с              | 1.20 Мб/с              | 1.01 Мб/с              |
| **Коментарии**       | 16 Кб/с          | 4.16 Кб/с              | 4.16 Кб/с              | 4.16 Кб/с              | 3.52 Кб/с              |
|**Коментарии(чтение)**| 33 Мб/с          | 8.58 Мб/с              | 8.58 Мб/с              | 8.58 Мб/с              | 7.26 Мб/с              |
| **Рекомендации**     | 53.3 Мб/с        | 13.86 Мб/с             | 13.86 Мб/с             | 13.86 Мб/с             | 11.73 Мб/с             |
| **Регистрация**      | 0.01 Кб/с        | 0.0026 Кб/с            | 0.0026 Кб/с            | 0.0026 Кб/с            | 0.0022 Кб/с            |
| **Подписка**         | 2.4 Кб/с         | 0.624 Кб/с             | 0.624 Кб/с             | 0.624 Кб/с             | 0.528 Кб/с             |
| **Монетизация**      | -                | -                      | -                      | -                      | -                      |
| **Поиск**            | 0.86 Мб/с        | 0.224 Мб/с             | 0.224 Мб/с             | 0.224 Мб/с             | 0.189 Мб/с             |
| **Авторизация**            | 6 Кб/с        | 1,56 Мб/с             | 1,56 Мб/с             | 1,56 Мб/с             | 1,32 Мб/с             |
| **Итого (Сеть пик)** | **~27.79 Гб/с**  | **7.23 Гб/с**          | **7.23 Гб/с**          | **7.23 Гб/с**          | **6.12 Гб/с**          |


| Действие             | RPS пик | **Москва ДЦ 1 (26%)** | **Москва ДЦ 2 (26%)** | **Москва ДЦ 3 (26%)** | **Новосибирск (22%)** |
|----------------------|---------|------------------------|------------------------|------------------------|------------------------|
| Лента постов         | 620     | 161                    | 161                    | 161                    | 136                    |
| Чтение постов        | 9 300   | 2 418                  | 2 418                  | 2 418                  | 2 046                  |
| Написание постов     | 2       | 0.52                   | 0.52                   | 0.52                   | 0.44                   |
| Коментарии           | 16      | 4.16                   | 4.16                   | 4.16                   | 3.52                   |
| Коментарии(чтение)   | 4 150   | 1 079                  | 1 079                  | 1 079                  | 913                    |
| Рекомендации         | 10 900  | 2 834                  | 2 834                  | 2 834                  | 2 398                  |
| Регистрация          | 0.002   | 0.00052                | 0.00052                | 0.00052                | 0.00044                |
| Подписка             | 1.2     | 0.312                  | 0.312                  | 0.312                  | 0.264                  |
| Поиск                | 165     | 42.9                   | 42.9                   | 42.9                   | 36.3                   |
| Авторизация          | 6     | 1,5                   | 1,5                   | 1,5                   | 1,3                   |
| **Итого (RPS пик)**  | **25 170** | **7 497**            | **7 497**            | **7 497**            | **6 348**            |

## 4. Локальная балансировка нагрузки

Будем использовать kubernetes с auto scaling. kubernetes будет сам создавать контейнеры (при запуске ждёт когда откликнется на health check), проверять контейнеры и перезапускать их. Так же с auto scaling (при настройке) может сам дополнительно запускать инстансы сервисов.

L7 - HTTP Reverse proxy (Используем Nginx. Поидее Nginx Ingress Controller из-за kubernetes)
- Для балансировщика отдельный сервис keepalived - для мониторига жизни. Используем VRRP для
  - Для проверки работоспособности будем делать GET запрос на специальную ручку которая будет поверять своё внутреннее состояние
- Балансеров 2N от пикового трафика (минимум 2 балансера)
- Может перезагружаться без остановки (мало кто умеет)
- SSL терминация (HTTPS)
- Gzip на лету
- Помогает бекенду (решает проблему очень медленного клиента)
- Api gateway
- Баласировка: round robin
- Кастомные заголовки для метрик
- Есть пассивная проверка бекенда - работа с живыми запросами
- Будем настраивать timeout на основе квантилей (99,99% по логам)

По данным nginx - на 2 cpu 2699v4 (уже слабенькие зеоны) 9000 rps с http (100кб) т.е. 1 балансировщик в ДЦ справляется (1 двухголовый сервак). Для резервирования 2N в каждом ДЦ будет 2 сервера. Итого 8 серверов

Для SSL терминации используем session tickets

## 5. Логическая схема БД

<img width="500" height="500" alt="Структура бд" src="https://github.com/user-attachments/assets/c235502f-a63b-4aaf-b1e6-233cf7e892c2" />

| **Название таблицы**       | **Описание** |
|----------------------------|--------------|
| profile                  | Таблица пользователя. Хранится информация о профиле. |
| subscription             | Таблица подписок пользователя |
| session                  | Хранит активные сессии аутентификации. Используется для управления авторизацией. |
| post                     | Хранит информацию о посте и его текст. |
| comment                  | Комментарии к постам. Поддерживает вложенные комментарии. |
| photo                    | Метаданные(url) изображений, загруженных в систему (хранятся в s3). |
| post_photo               | Промежуточная таблица для связи между постами и фотографиями. Позволяет добавлять несколько фото в один пост. |
| view_metric              | Аналитическая таблица, фиксирующая события просмотра постов |
| search_metric            | Аналитическая таблица, записывающая поисковые запросы пользователей |
| recommendation           | Хранит веса рекомендаций для каждого пользователя |

| Действие             | RPS пик |Какие таблицы|
|----------------------|---------|----|
| Лента постов         | 620     |пост, профиль и подписка, фото|
| Чтение постов        | 9 300   |пост, профиль, подписка, фото, фотки постов|
| Написание постов     | 2       |пост, профиль, сессия, фото, фотки постов|
| Коментарии           | 16      |профиль, коментарии и сессия|
| Коментарии(чтение)   | 4 150   |профиль, коментарии, фото|
| Рекомендации         | 10 900  |метрика просмотра, метрика поиска и подписка|
| Регистрация          | 0.002   |профиль|
| Подписка             | 1.2     |профиль, сессия и подписка|
| Поиск                | 165     |пост|
| Авторизация          | 6       |сессия, профиль|

**чтение**
- пост 620 + 9 300 + 2 + 165 = 10 087
- профиль 620 + 9 300 + 2 + 16 + 4 150 + 0.002 + 1.2 + 6 = 14 108
- сессия 2 + 16 + 1.2 = 19.2
- комментарии 4 150
- рекомендации 10 900
- метрика поиска 10 900
- метрика просмотра 10 900
- подписка 620 + 9 300 + 10 900 = 20 820
- фото 620 + 5,6 * 9 300 + 4 150 = 56 850
- фотки поста 9 300

**запись**
- пост 2
- профиль 0,002
- сессия 6
- коментарии 16
- рекомендации -
- метрика поиска 165
- метрика просмотра 9 300
- подписка 1.2
- фото 5,6 * 2 = 11,2
- фотки поста 2

## 6. Физическая схема БД

**Выбор СУБД (потаблично)**

<img width="1402" height="1182" alt="image" src="https://github.com/user-attachments/assets/9810827e-b256-442a-a372-e5bb167dac79" />


| **Название таблицы**       | **СУБД** | **Обоснование** |
|----------------------------|------------------------|----------------|
| profile              | PostgreSQL         | Структурированные данные пользователя (имя, email, настройки и т.д.) частые чтения и мало записи |
| subscription         | PostgreSQL         | Отношения многие-ко-многим (пользователь и автор).|
| session              | Redis              | Временные данные сессий, высокая частота чтения/удаления. |
| post                 | PostgreSQL         | Частые чтения и мало записей |
| search_post          | ElasticSearch      | Для поиска по постам |
| comment              | PostgreSQL         | Иерархическая структура (вложенные комментарии). Требуются рекурсивные запросы |
| photo                | Minio              | Храним сами фото |
| view_metric          | ClickHouse         | Только запись и одиночное чтение, агрегации по времени, пользователям, постам |
| search_metric        | ClickHouse         | Аналогично view_metric |
|recommendation        | Redis              | Быстро отдавать json по ключу поста|
|post_metric           | Postgresql + redis | В redis храним real time статистику, а в postgresql уже обновлённую для сохранности|

**Индексы**
- пост
  - id - стандартный индекс для поиска определённого поста btree
    - вес индекса 8 * 122 000 000 = 1 гб
  - author_id - показать посты автора btree
    - вес индекса 8 * 10 000 000 (предположительная оценка количества авторов) = 80 мб
- сессия
  - не требуется из-за redis
- комментарии
  - id - стандартный индекс btree
    - вес индекса 8 * 2 000 000 000 = 16 гб
  - post_id, created_at - показывать в постах (будут отсортированны по дате создани что бы каждый раз был одинаковый порядок btree
    - вес индекса 16 * 2 000 000 000 = 32 гб
  - id, parent_id, created_at - показывать ответы на комменатрий btree
    - вес индекса 24 * 2 000 000 000 = 48 гб
- подписка
  - id - стандартный индекс btree
    - вес индекса 8 * 300 000 000 = 2,4 Гб
  - author_id, subscriber_id - для подписок на автора btree
    - вес индекса 16 * 68 000 000 = 4,8 гб
- поиск
  - id - стандартный индекс btree
    - вес индекса 8 * 122 000 000 = 1 гб
  - title - поиск по названию gin
    - вес индекса 100 * 122 000 000 = 12 гб
  - author - поиск по автору gin
    - вес индекса 100 * 100 000 000 * 0,2 = 2 гб
- выплаты
  - id - стандартный индекс btree
    - вес индекса 8 * 1 000 000 (авторы с монетизацией так как 100 000 авторов пишут ежедневно) * 365 * 5 = 14,5 Гб
- профиль
  - id - стандартный индекс btree
    - вес индекса 8 * 100 000 000 = 1 гб


**Денормализация**
- пост
  - просмотры
  - клики
  - фото шапки
  - фотки поста text[] ссылок на фото - что бы убрать join с картиками
- профиль
  - количество подпискок - не делать агрегированный join по подпискам
  - фото профиля теперь url
- поиск
  - в 1 таблице join поста и автора
- подписки
  - название канала автора
  - аватарка канала - что бы не делать join с каждой подпиской
- метрики
  - вынесли и в redis и в postgresql - в первом свежие данные, а во втором для хранения
- рекомендации
  - в json хранится информация о посте: шапка, название, автор, аватар, обрезанный текст 200 символов
- метрика просмотра
  - хранится допом id автора что бы было удобнее считать рекомендации

**Размеры данных (строки, байты)**

на строку:
- post_search: 8 + 8 + 150 + 8 000 + 8 + 8 = 8 182
- post: 8 + 150 + 8 000 + 8 + 8 + 8 + 8 + 8 + 5,6 * 128 + 8 + 8 + 8 = 8939
- session: 256 + 8 + 8 = 272
- profile: 8 + 100 + 256 + 8 + 150 + 128 + 8 + 8 + 8 + 8 + 8 + 8 = 698
- view_metrics: 8 + 8 + 8 + 8 + 8 + 8 + 8 + 8 = 64
- recommendation: 8 + 8 + 2000 = 2 016
- search_metrics: 8 + 8 + 256 = 272
- subscription: 8 + 8 + 8 + 100 + 100 = 224
- payment: 8 + 8 + 8 + 8 + 8 = 40
- comment: 8 + 8 + 8 + 8 + 1 000 + 8 + 8 + 8 = 1 056
- photo: 128 + 8 + 8 = 144
- post_metric: 8 + 8 + 8 + 8 + 8 = 40

всего:
- post_search: 8 182 * 122 000 000  = 998 гб
- post: 8939 * 122 000 000 = 1,09 Тб
- session: 272 * (79 000 000 * 0,6 * 1,1) = 272 * 52 100 000 = 14,1 Гб
- profile: 698 * 100 000 000 = 68,9 Гб
- view_metrics: 64 * 15 * 31 000 000 * 30 = 64 * 13 900 000 000 = 890 гб
- recommendation: Пусть каждый пост имеет в среднем 20 кандидатов. Вес 1 кандидата: 8 + 256 (веса для score) = 264 байта => 264 * 20 = 5,3 Кб. Мы рассматриваем 10 млн статей => 53 Гб
- search_metrics: 272 * 0,27 * 31 000 000 * 30 = 272 * 251 000 000 = 68,3 гб
- subscription: 224 * 5 000 000 * 12 * 5 = 224 * 300 000 000 = 67,2 гб 
- payment: 40 * 100 000 писателей * 30 * 12 * 10 = 40 * 360 000 000 = 0,5 гб
- comment: 1 056 * 2 000 000 000 = 2,11 Тб
- photo: 100 000 000 * 0,33 * 1,5 = 49 тб <br>340 * 5,6 * 122 000 000 = 233 тб <br> 49 + 233 = 282 тб
- post_metric: 40 * 122 000 000 = 4,88 Гб

**Шардирование и резервирование СУБД (потаблично)**

по бенчмарку pgbnech[22] средний сервер выдаёт 500 000 tps

| **Название таблицы**       | **Шардирование** | **Резервирование** |
|----------------------------|------------------------|----------------|
| profile                    |                        | 1 реплика      | 
| subscription               |                        | 1 реплика      |
| session                    |                        | 1 реплика      | 
| post                       |                        | 1 реплика      |
| search_post                |                        | 1 реплика      | 
| comment                    |  8 шардов по post_id mod 8 | 1 реплики  |
| photo                      |                        | 1 реплика      |
| view_metric                |                        | 1 реплика      |
| search_metric              |                        | 1 реплика      |
| post_metric                |                        | 1 реплика      |
| recomendation              | 8 шардов по post_id mod 8 | 1 реплика   |

Индексы comment весят 16 + 32 + 48 = 96 гб. Индекс не влезает в стандартный под оперативной памяти.

Если разбить comment на 8 шардов получим на каждый 96 / 8 = 12, но зная возможность того что на 1 шарде будет больше коментариев (в каких-то постах больше постов) умноим на коэфф. 1,5 и получим 18 гб.

Будем шардировать по post_id что бы можно было получать коментарии к посту. Для того чтобы показать свой комментарий на пост первым надо из всех коментариев к этому посту (находятся в 1 шарде) выбрать тот у кого user_id = нужному

Если будет необходим функционал просмотра всех своих комментариев то придётся идти по всем 8 шардам и собирать их.

Для рекомнаций шардируем из-за слишком большого объёма. Шардируем на 8 чтобы в будущем могли анализировать не 4 месяца (10 млн), а за весь год (30 млн+), а так же для запаса на будущее. Шардируем по post_id что бы получать кандиатов на пост.

**Клиентские библиотеки / интеграции**

- https://github.com/redis/go-redis
- https://github.com/elastic/go-elasticsearch
- https://github.com/jackc/pgx
- https://github.com/ClickHouse/clickhouse-go
- https://github.com/minio/minio

**Балансировка запросов / мультиплексирование подключений**

- postgresql - pgbounce
- elasticsearch - встроенный
- redis - встроенный
- clickhouse - встроенный

**Схема резервного копирования**

все бекапы с реплик:
- физические каждый день - postgresql, clickhouse
- postgresql wal каждые 10 минут - сможем откатиться
- снапшоты redis - каждый час
- elastic - снапшоты каждый день
- clickhouse - бекап с помощью clickhouse-backup каждые 3 дня

# 7. Алгоритмы

**Рекомендации**
Будем как позитивы использовать чтение более 80% поста. По статистике канала "Упал поднялся" в среднем читают 60% поста, при этом полных дочиток (100% статьи) 10%, отсюда сделаем предположение о 20% читают 80% всей статьи.

В месяц 14 000 000 000 просмотров * 0,2 шанс позитива = 2 800 000 000 позитивов. В месяц пишут 2,7 млн постов. Для выборки рекомендаций будем использовать 10 млн постов за последние 4 месяца.

<img width="945" height="520" alt="image" src="https://github.com/user-attachments/assets/68572fd3-3ade-44d5-9f3b-050f17ac4d0b" />
 
Пользователь со своей историей приходит в рекомендации. JOIN берутся просмотренные документ и кандидаты на рекомендацию. Оффлайн создаём список: пост – [кандидаты, …].

Для создания списка надо создать классификатор похожести для это наймём людей на краудинг (ручная разметка) и на основе ответов построим модельку. После будем использовать контентную похожесть и похожесть авторов.

Как сделать похожесть контента и авторов: для этого используем модель типа BERT [21] для классификации тематики. Для похожести авторов воспользуемся KNN

3 составляющие: моделька на краудинге, похожесть контента и похожесть авторов будет давать нам какое-то значение. По этому значению будем находить кандидатов если значение> 0,5.

Чтобы ускорить выполнение будем брать в кандидаты только первые 10 похожих постов. Для определения какие посты брать создадим бустинг с помощью catboost на основе среднего % прочтения рекомендованной статьи.

 <img width="414" height="422" alt="image" src="https://github.com/user-attachments/assets/75ccb190-fb6f-40d4-89d7-57890563cb14" />

Из-за того, что у нас слишком много постов (120+ млн) то перед item2item сделаем фильтр по knn

Т.е. для рекомендации нам нужная таблица item2item, где будем хранить id поста, список релевантных с author_id, весами по тематике поста. Пусть каждый пост имеет в среднем 20 кандидатов. Вес 1 кандидата: 8 + 256 (веса для score) = 264 байта => 264 * 20 = 5,3 Кб. Мы рассматриваем 10 млн статей => 53 Гб памяти занимает i2i. Разделим redis на 8 шардов по 6,6 Гб для задела на будущее и анализа постов за больший промежуток (например, на год)

## Ссылки

1. https://www.youtube.com/watch?v=IXEde53P0Jg - 1:38
2. https://zenstat.ru/stat/posts/?search=&sort=views&order=asc&offset=0&limit=50&type_post=card&date_from=2025-08-06&date_to=2025-09-04&period=30&post_text=&post_text_minus=&views_min=&views_max=&channel_subscribers_min=&channel_subscribers_max=&channel_publications_30days=&fast_load=1
3. https://dzen.ru/about
4. https://habr.com/ru/news/532670/
5. https://dzen.ru/about/itogi2023
6. https://dzen.ru/itogi-2024
7. https://corp.vkcdn.ru/media/files/RUS_Results_Presentation_H1_2025.pdf - 7 стр
8. https://hypestat.com/info/dzen.ru
9. https://dzen.ru/about/careers
10. https://dzen.ru/a/ZYWi7bChZQJnLS9d
11. https://dzen.ru/a/aH3qbkqCAA5vD3ht
12. https://zenstat.ru/stat/channels/
13. https://habr.com/ru/articles/914310/
14. https://searchengines.guru/ru/news/2057604?utm_medium=organic&utm_source=yandexsmartcamera
15. https://dzen.ru/a/ZYWi7bChZQJnLS9d


[1]: https://www.youtube.com/watch?v=IXEde53P0Jg
[2]: https://zenstat.ru/stat/posts/?search=&sort=views&order=asc&offset=0&limit=50&type_post=card&date_from=2025-08-06&date_to=2025-09-04&period=30&post_text=&post_text_minus=&views_min=&views_max=&channel_subscribers_min=&channel_subscribers_max=&channel_publications_30days=&fast_load=1
[3]: https://dzen.ru/about
[4]: https://habr.com/ru/news/532670/
[5]: https://dzen.ru/about/itogi2023
[6]: https://dzen.ru/itogi-2024
[7]: https://corp.vkcdn.ru/media/files/RUS_Results_Presentation_H1_2025.pdf
[8]: https://hypestat.com/info/dzen.ru
[9]: https://dzen.ru/about/careers
[10]: https://dzen.ru/a/ZYWi7bChZQJnLS9d
[11]: https://dzen.ru/a/aH3qbkqCAA5vD3ht
[12]: https://zenstat.ru/stat/channels/
[13]: https://habr.com/ru/articles/914310/
[14]: https://searchengines.guru/ru/news/2057604?utm_medium=organic&utm_source=yandexsmartcamera
[15]: https://dzen.ru/a/ZYWi7bChZQJnLS9d
[16]: https://www.cnews.ru/news/line/2022-12-23_dzen_podvel_itogi_2022_goda
[17]: https://supa.ru/blog/posts/v-2019-ghodu-iandieks-dzien-udvoil-mnoghiie-pokazatieli
[18]: https://ru.wikipedia.org/wiki/%D0%93%D0%BE%D1%80%D0%BE%D0%B4%D0%B0_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B8_%D1%81_%D0%BD%D0%B0%D1%81%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%D0%BC_%D0%B1%D0%BE%D0%BB%D0%B5%D0%B5_500_%D1%82%D1%8B%D1%81%D1%8F%D1%87_%D1%87%D0%B5%D0%BB%D0%BE%D0%B2%D0%B5%D0%BA
[19]: https://habr.com/en/companies/skillfactory/articles/862130/
[20]: https://www.comnews.ru/content/211042/2020-10-21/2020-w43/magistralnye-seti-svyazi-rossii
[21]: https://leadmachine.ru/2020/08/05/content-marketing-vs-yandex-dzen/?utm_medium=organic&utm_source=yandexsmartcamera
[22]: https://openbenchmarking.org/result/2510061-NE-2510055NE79#r-7e3cefef86b702f438318e5f7cc7938646057dc9
